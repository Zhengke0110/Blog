import{_ as p}from"./Post.dd5dd46a.js";import{u as l,c,w as u,o as r,a as n,b as s}from"./app.038d67a7.js";const _="QLoRA\uFF1A\u91CF\u5316\u4F4E\u79E9\u9002\u5E94\u6280\u672F",b="2025-08-14T00:00:00.000Z",f="llm",h=[{property:"og:title",content:"QLoRA\uFF1A\u91CF\u5316\u4F4E\u79E9\u9002\u5E94\u6280\u672F"}],y={__name:"Model-fine-tuning-QLoRA",setup(i,{expose:o}){const a={title:"QLoRA\uFF1A\u91CF\u5316\u4F4E\u79E9\u9002\u5E94\u6280\u672F",date:"2025-08-14T00:00:00.000Z",type:"llm",meta:[{property:"og:title",content:"QLoRA\uFF1A\u91CF\u5316\u4F4E\u79E9\u9002\u5E94\u6280\u672F"}]};return o({frontmatter:a}),l({title:"QLoRA\uFF1A\u91CF\u5316\u4F4E\u79E9\u9002\u5E94\u6280\u672F",meta:[{property:"og:title",content:"QLoRA\uFF1A\u91CF\u5316\u4F4E\u79E9\u9002\u5E94\u6280\u672F"}]}),(d,t)=>{const e=p;return r(),c(e,{frontmatter:a},{default:u(()=>[...t[0]||(t[0]=[n("div",{class:"prose m-auto"},[n("h2",{id:"\u6982\u8FF0",tabindex:"-1"},[s("\u6982\u8FF0 "),n("a",{class:"header-anchor",href:"#\u6982\u8FF0","aria-hidden":"true"},"#")]),n("p",null,"QLoRA (Quantized Low-Rank Adaptation) \u662F\u5728 LoRA \u57FA\u7840\u4E0A\u8FDB\u4E00\u6B65\u4F18\u5316\u7684\u53C2\u6570\u9AD8\u6548\u5FAE\u8C03\u6280\u672F\uFF0C\u7531\u534E\u76DB\u987F\u5927\u5B66\u5728 2023 \u5E74\u63D0\u51FA\u3002QLoRA \u7ED3\u5408\u4E86\u91CF\u5316\u6280\u672F\u548C\u4F4E\u79E9\u9002\u5E94\uFF0C\u901A\u8FC7 4-bit \u91CF\u5316\u5927\u5E45\u964D\u4F4E\u5185\u5B58\u5360\u7528\uFF0C\u4F7F\u5F97\u5728\u6D88\u8D39\u7EA7\u786C\u4EF6\u4E0A\u5FAE\u8C03\u5927\u578B\u8BED\u8A00\u6A21\u578B\u6210\u4E3A\u53EF\u80FD\u3002"),n("h3",{id:"\u6838\u5FC3\u521B\u65B0",tabindex:"-1"},[s("\u6838\u5FC3\u521B\u65B0 "),n("a",{class:"header-anchor",href:"#\u6838\u5FC3\u521B\u65B0","aria-hidden":"true"},"#")]),n("p",null,"QLoRA \u7684\u6838\u5FC3\u521B\u65B0\u5728\u4E8E\uFF1A"),n("ol",null,[n("li",null,[n("strong",null,"4-bit NormalFloat (NF4) \u91CF\u5316"),s("\uFF1A\u7406\u8BBA\u6700\u4F18\u7684 4-bit \u91CF\u5316\u683C\u5F0F")]),n("li",null,[n("strong",null,"\u53CC\u91CD\u91CF\u5316"),s("\uFF1A\u5BF9\u91CF\u5316\u5E38\u6570\u8FDB\u884C\u4E8C\u6B21\u91CF\u5316\uFF0C\u8FDB\u4E00\u6B65\u8282\u7701\u5185\u5B58")]),n("li",null,[n("strong",null,"\u5206\u9875\u6CE8\u610F\u529B"),s("\uFF1A\u5904\u7406\u8BAD\u7EC3\u8FC7\u7A0B\u4E2D\u7684\u5185\u5B58\u5CF0\u503C")]),n("li",null,[n("strong",null,"\u4FDD\u6301 LoRA \u7CBE\u5EA6"),s("\uFF1A\u9002\u914D\u5668\u6743\u91CD\u4F7F\u7528 16-bit \u7CBE\u5EA6")])]),n("pre",{class:"language-mermaid"},[n("code",{class:"language-mermaid"},[n("span",{class:"token keyword"},"graph"),s(` TB
    A`),n("span",{class:"token text string"},"[\u9884\u8BAD\u7EC3\u6A21\u578B]"),s(),n("span",{class:"token arrow operator"},"-->"),s(" B"),n("span",{class:"token text string"},"[4-bit \u91CF\u5316]"),s(`
    B `),n("span",{class:"token arrow operator"},"-->"),s(" C"),n("span",{class:"token text string"},"[\u51BB\u7ED3\u57FA\u7840\u6743\u91CD]"),s(`
    C `),n("span",{class:"token arrow operator"},"-->"),s(" D"),n("span",{class:"token text string"},"[\u6DFB\u52A0 LoRA \u9002\u914D\u5668]"),s(`
    D `),n("span",{class:"token arrow operator"},"-->"),s(" E"),n("span",{class:"token text string"},"[16-bit \u9002\u914D\u5668\u8BAD\u7EC3]"),s(`
    E `),n("span",{class:"token arrow operator"},"-->"),s(" F"),n("span",{class:"token text string"},"[QLoRA \u6A21\u578B]"),s(`

    G`),n("span",{class:"token text string"},"[\u5185\u5B58\u8282\u7701]"),s(),n("span",{class:"token arrow operator"},"-->"),s(" H"),n("span",{class:"token text string"},"[65B \u6A21\u578B<br/>\u5355 GPU \u53EF\u8BAD\u7EC3]"),s(`

    `),n("span",{class:"token keyword"},"style"),s(" B "),n("span",{class:"token style"},[n("span",{class:"token property"},"fill"),n("span",{class:"token operator"},":"),s("#e1f5fe")]),s(`
    `),n("span",{class:"token keyword"},"style"),s(" D "),n("span",{class:"token style"},[n("span",{class:"token property"},"fill"),n("span",{class:"token operator"},":"),s("#f3e5f5")]),s(`
    `),n("span",{class:"token keyword"},"style"),s(" F "),n("span",{class:"token style"},[n("span",{class:"token property"},"fill"),n("span",{class:"token operator"},":"),s("#e8f5e8")]),s(`
`)])]),n("h3",{id:"\u6280\u672F\u4F18\u52BF",tabindex:"-1"},[s("\u6280\u672F\u4F18\u52BF "),n("a",{class:"header-anchor",href:"#\u6280\u672F\u4F18\u52BF","aria-hidden":"true"},"#")]),n("p",null,"\u76F8\u6BD4\u4F20\u7EDF\u65B9\u6CD5\uFF0CQLoRA \u5177\u6709\u663E\u8457\u4F18\u52BF\uFF1A"),n("ol",null,[n("li",null,[n("strong",null,"\u5185\u5B58\u6548\u7387"),s("\uFF1A\u76F8\u6BD4 16-bit LoRA \u8282\u7701\u7EA6 33% \u5185\u5B58")]),n("li",null,[n("strong",null,"\u6027\u80FD\u4FDD\u6301"),s("\uFF1A\u63A5\u8FD1\u5168\u7CBE\u5EA6\u8BAD\u7EC3\u7684\u6548\u679C")]),n("li",null,[n("strong",null,"\u786C\u4EF6\u53CB\u597D"),s("\uFF1A\u6D88\u8D39\u7EA7 GPU \u53EF\u8BAD\u7EC3\u5927\u6A21\u578B")]),n("li",null,[n("strong",null,"\u90E8\u7F72\u4FBF\u5229"),s("\uFF1A\u91CF\u5316\u6A21\u578B\u4FBF\u4E8E\u90E8\u7F72")])]),n("h2",{id:"\u6280\u672F\u539F\u7406",tabindex:"-1"},[s("\u6280\u672F\u539F\u7406 "),n("a",{class:"header-anchor",href:"#\u6280\u672F\u539F\u7406","aria-hidden":"true"},"#")]),n("h3",{id:"nf4-\u91CF\u5316\u673A\u5236",tabindex:"-1"},[s("NF4 \u91CF\u5316\u673A\u5236 "),n("a",{class:"header-anchor",href:"#nf4-\u91CF\u5316\u673A\u5236","aria-hidden":"true"},"#")]),n("p",null,"NF4 (4-bit NormalFloat) \u662F\u4E13\u4E3A\u6B63\u6001\u5206\u5E03\u6743\u91CD\u8BBE\u8BA1\u7684\u91CF\u5316\u683C\u5F0F\uFF0C\u57FA\u4E8E\u795E\u7ECF\u7F51\u7EDC\u6743\u91CD\u901A\u5E38\u9075\u5FAA\u6B63\u6001\u5206\u5E03\u7684\u7279\u6027\u8FDB\u884C\u4F18\u5316\u3002"),n("p",null,[n("strong",null,"\u6838\u5FC3\u601D\u60F3"),s("\uFF1A")]),n("ul",null,[n("li",null,"\u4F20\u7EDF Int4 \u91CF\u5316\u5047\u8BBE\u6743\u91CD\u5747\u5300\u5206\u5E03"),n("li",null,"NF4 \u9488\u5BF9\u6B63\u6001\u5206\u5E03\u8FDB\u884C\u91CF\u5316\u7EA7\u522B\u4F18\u5316"),n("li",null,"\u4F7F\u7528 16 \u4E2A\u7CBE\u5FC3\u8BBE\u8BA1\u7684\u91CF\u5316\u7EA7\u522B\uFF0C\u5728 [-1, 1] \u8303\u56F4\u5185\u4E0D\u5747\u5300\u5206\u5E03")]),n("h3",{id:"\u53CC\u91CD\u91CF\u5316",tabindex:"-1"},[s("\u53CC\u91CD\u91CF\u5316 "),n("a",{class:"header-anchor",href:"#\u53CC\u91CD\u91CF\u5316","aria-hidden":"true"},"#")]),n("p",null,"\u4E3A\u8FDB\u4E00\u6B65\u51CF\u5C11\u5185\u5B58\u5360\u7528\uFF0CQLoRA \u5BF9\u91CF\u5316\u5E38\u6570\u8FDB\u884C\u4E8C\u6B21\u91CF\u5316\uFF1A"),n("ol",null,[n("li",null,[n("strong",null,"\u7B2C\u4E00\u5C42\u91CF\u5316"),s("\uFF1A\u5C06\u6743\u91CD\u91CF\u5316\u4E3A 4-bit")]),n("li",null,[n("strong",null,"\u7B2C\u4E8C\u5C42\u91CF\u5316"),s("\uFF1A\u5C06\u7F29\u653E\u56E0\u5B50\u91CF\u5316\u4E3A 8-bit")]),n("li",null,[n("strong",null,"\u5185\u5B58\u8282\u7701"),s("\uFF1A\u989D\u5916\u8282\u7701\u7EA6 0.37 bit/\u53C2\u6570")])]),n("h3",{id:"\u5206\u9875\u6CE8\u610F\u529B",tabindex:"-1"},[s("\u5206\u9875\u6CE8\u610F\u529B "),n("a",{class:"header-anchor",href:"#\u5206\u9875\u6CE8\u610F\u529B","aria-hidden":"true"},"#")]),n("p",null,"\u5904\u7406\u8BAD\u7EC3\u8FC7\u7A0B\u4E2D\u7684\u5185\u5B58\u5CF0\u503C\u95EE\u9898\uFF1A"),n("ul",null,[n("li",null,"\u5C06\u4E34\u65F6\u6FC0\u6D3B\u503C\u5B58\u50A8\u5230 CPU"),n("li",null,"\u9700\u8981\u65F6\u518D\u52A0\u8F7D\u5230 GPU"),n("li",null,"\u907F\u514D\u5185\u5B58\u6EA2\u51FA")]),n("h2",{id:"\u5B9E\u73B0\u8981\u70B9",tabindex:"-1"},[s("\u5B9E\u73B0\u8981\u70B9 "),n("a",{class:"header-anchor",href:"#\u5B9E\u73B0\u8981\u70B9","aria-hidden":"true"},"#")]),n("h3",{id:"qlora-\u5C42\u7ED3\u6784",tabindex:"-1"},[s("QLoRA \u5C42\u7ED3\u6784 "),n("a",{class:"header-anchor",href:"#qlora-\u5C42\u7ED3\u6784","aria-hidden":"true"},"#")]),n("p",null,"QLoRA \u5C42\u7531\u4E24\u4E2A\u4E3B\u8981\u7EC4\u4EF6\u6784\u6210\uFF1A"),n("ol",null,[n("li",null,[n("strong",null,"\u91CF\u5316\u57FA\u7840\u6743\u91CD"),s("\uFF1A\u4F7F\u7528 4-bit NF4 \u683C\u5F0F\u5B58\u50A8\uFF0C\u51BB\u7ED3\u4E0D\u8BAD\u7EC3")]),n("li",null,[n("strong",null,"LoRA \u9002\u914D\u5668"),s("\uFF1A\u4FDD\u6301 16-bit \u7CBE\u5EA6\uFF0C\u53C2\u4E0E\u8BAD\u7EC3")])]),n("pre",{class:"language-python"},[n("code",{class:"language-python"},[n("span",{class:"token keyword"},"class"),s(),n("span",{class:"token class-name"},"QLoRALinear"),n("span",{class:"token punctuation"},"("),s("nn"),n("span",{class:"token punctuation"},"."),s("Module"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},":"),s(`
    `),n("span",{class:"token keyword"},"def"),s(),n("span",{class:"token function"},"__init__"),n("span",{class:"token punctuation"},"("),s("self"),n("span",{class:"token punctuation"},","),s(" in_features"),n("span",{class:"token punctuation"},","),s(" out_features"),n("span",{class:"token punctuation"},","),s(" r"),n("span",{class:"token operator"},"="),n("span",{class:"token number"},"4"),n("span",{class:"token punctuation"},","),s(" lora_alpha"),n("span",{class:"token operator"},"="),n("span",{class:"token number"},"32"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},":"),s(`
        `),n("span",{class:"token builtin"},"super"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},"."),s("__init__"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(`

        `),n("span",{class:"token comment"},"# 4-bit \u91CF\u5316\u7684\u57FA\u7840\u6743\u91CD\uFF08\u51BB\u7ED3\uFF09"),s(`
        self`),n("span",{class:"token punctuation"},"."),s("weight_quantized "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token boolean"},"None"),s(`
        self`),n("span",{class:"token punctuation"},"."),s("weight_scales "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token boolean"},"None"),s(`

        `),n("span",{class:"token comment"},"# 16-bit LoRA \u9002\u914D\u5668\uFF08\u53EF\u8BAD\u7EC3\uFF09"),s(`
        self`),n("span",{class:"token punctuation"},"."),s("lora_A "),n("span",{class:"token operator"},"="),s(" nn"),n("span",{class:"token punctuation"},"."),s("Parameter"),n("span",{class:"token punctuation"},"("),s("torch"),n("span",{class:"token punctuation"},"."),s("zeros"),n("span",{class:"token punctuation"},"("),s("r"),n("span",{class:"token punctuation"},","),s(" in_features"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(`
        self`),n("span",{class:"token punctuation"},"."),s("lora_B "),n("span",{class:"token operator"},"="),s(" nn"),n("span",{class:"token punctuation"},"."),s("Parameter"),n("span",{class:"token punctuation"},"("),s("torch"),n("span",{class:"token punctuation"},"."),s("zeros"),n("span",{class:"token punctuation"},"("),s("out_features"),n("span",{class:"token punctuation"},","),s(" r"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(`
        self`),n("span",{class:"token punctuation"},"."),s("scaling "),n("span",{class:"token operator"},"="),s(" lora_alpha "),n("span",{class:"token operator"},"/"),s(` r

    `),n("span",{class:"token keyword"},"def"),s(),n("span",{class:"token function"},"forward"),n("span",{class:"token punctuation"},"("),s("self"),n("span",{class:"token punctuation"},","),s(" x"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},":"),s(`
        `),n("span",{class:"token comment"},"# \u53CD\u91CF\u5316\u57FA\u7840\u6743\u91CD"),s(`
        base_weight `),n("span",{class:"token operator"},"="),s(" self"),n("span",{class:"token punctuation"},"."),s("dequantize_weight"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(`

        `),n("span",{class:"token comment"},"# \u57FA\u7840\u53D8\u6362 + LoRA \u9002\u5E94"),s(`
        result `),n("span",{class:"token operator"},"="),s(" F"),n("span",{class:"token punctuation"},"."),s("linear"),n("span",{class:"token punctuation"},"("),s("x"),n("span",{class:"token punctuation"},","),s(" base_weight"),n("span",{class:"token punctuation"},")"),s(`
        `),n("span",{class:"token keyword"},"if"),s(" self"),n("span",{class:"token punctuation"},"."),s("r "),n("span",{class:"token operator"},">"),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},":"),s(`
            lora_result `),n("span",{class:"token operator"},"="),s(" x @ self"),n("span",{class:"token punctuation"},"."),s("lora_A"),n("span",{class:"token punctuation"},"."),s("T @ self"),n("span",{class:"token punctuation"},"."),s("lora_B"),n("span",{class:"token punctuation"},"."),s(`T
            result `),n("span",{class:"token operator"},"+="),s(" lora_result "),n("span",{class:"token operator"},"*"),s(" self"),n("span",{class:"token punctuation"},"."),s(`scaling

        `),n("span",{class:"token keyword"},"return"),s(` result
`)])]),n("h3",{id:"\u6A21\u578B\u8F6C\u6362",tabindex:"-1"},[s("\u6A21\u578B\u8F6C\u6362 "),n("a",{class:"header-anchor",href:"#\u6A21\u578B\u8F6C\u6362","aria-hidden":"true"},"#")]),n("p",null,"\u4F7F\u7528\u73B0\u6709\u5E93\u5FEB\u901F\u5B9E\u73B0 QLoRA\uFF1A"),n("pre",{class:"language-python"},[n("code",{class:"language-python"},[n("span",{class:"token keyword"},"from"),s(" transformers "),n("span",{class:"token keyword"},"import"),s(" AutoModelForCausalLM"),n("span",{class:"token punctuation"},","),s(` BitsAndBytesConfig
`),n("span",{class:"token keyword"},"from"),s(" peft "),n("span",{class:"token keyword"},"import"),s(" LoraConfig"),n("span",{class:"token punctuation"},","),s(` get_peft_model

`),n("span",{class:"token comment"},"# 1. \u91CF\u5316\u914D\u7F6E"),s(`
bnb_config `),n("span",{class:"token operator"},"="),s(" BitsAndBytesConfig"),n("span",{class:"token punctuation"},"("),s(`
    load_in_4bit`),n("span",{class:"token operator"},"="),n("span",{class:"token boolean"},"True"),n("span",{class:"token punctuation"},","),s(`
    bnb_4bit_quant_type`),n("span",{class:"token operator"},"="),n("span",{class:"token string"},'"nf4"'),n("span",{class:"token punctuation"},","),s(`
    bnb_4bit_use_double_quant`),n("span",{class:"token operator"},"="),n("span",{class:"token boolean"},"True"),n("span",{class:"token punctuation"},","),s(`
    bnb_4bit_compute_dtype`),n("span",{class:"token operator"},"="),s("torch"),n("span",{class:"token punctuation"},"."),s(`float16
`),n("span",{class:"token punctuation"},")"),s(`

`),n("span",{class:"token comment"},"# 2. \u52A0\u8F7D\u91CF\u5316\u6A21\u578B"),s(`
model `),n("span",{class:"token operator"},"="),s(" AutoModelForCausalLM"),n("span",{class:"token punctuation"},"."),s("from_pretrained"),n("span",{class:"token punctuation"},"("),s(`
    `),n("span",{class:"token string"},'"model_name"'),n("span",{class:"token punctuation"},","),s(`
    quantization_config`),n("span",{class:"token operator"},"="),s("bnb_config"),n("span",{class:"token punctuation"},","),s(`
    device_map`),n("span",{class:"token operator"},"="),n("span",{class:"token string"},'"auto"'),s(`
`),n("span",{class:"token punctuation"},")"),s(`

`),n("span",{class:"token comment"},"# 3. \u6DFB\u52A0 LoRA \u9002\u914D\u5668"),s(`
lora_config `),n("span",{class:"token operator"},"="),s(" LoraConfig"),n("span",{class:"token punctuation"},"("),s(`
    r`),n("span",{class:"token operator"},"="),n("span",{class:"token number"},"8"),n("span",{class:"token punctuation"},","),s(`
    lora_alpha`),n("span",{class:"token operator"},"="),n("span",{class:"token number"},"32"),n("span",{class:"token punctuation"},","),s(`
    target_modules`),n("span",{class:"token operator"},"="),n("span",{class:"token punctuation"},"["),n("span",{class:"token string"},'"q_proj"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"v_proj"'),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},","),s(`
    lora_dropout`),n("span",{class:"token operator"},"="),n("span",{class:"token number"},"0.1"),n("span",{class:"token punctuation"},","),s(`
    task_type`),n("span",{class:"token operator"},"="),n("span",{class:"token string"},'"CAUSAL_LM"'),s(`
`),n("span",{class:"token punctuation"},")"),s(`

model `),n("span",{class:"token operator"},"="),s(" get_peft_model"),n("span",{class:"token punctuation"},"("),s("model"),n("span",{class:"token punctuation"},","),s(" lora_config"),n("span",{class:"token punctuation"},")"),s(`
`)])]),n("h2",{id:"\u6027\u80FD\u5206\u6790",tabindex:"-1"},[s("\u6027\u80FD\u5206\u6790 "),n("a",{class:"header-anchor",href:"#\u6027\u80FD\u5206\u6790","aria-hidden":"true"},"#")]),n("h3",{id:"\u5185\u5B58\u4F7F\u7528\u5BF9\u6BD4",tabindex:"-1"},[s("\u5185\u5B58\u4F7F\u7528\u5BF9\u6BD4 "),n("a",{class:"header-anchor",href:"#\u5185\u5B58\u4F7F\u7528\u5BF9\u6BD4","aria-hidden":"true"},"#")]),n("p",null,"QLoRA \u5728\u5185\u5B58\u4F7F\u7528\u65B9\u9762\u5177\u6709\u663E\u8457\u4F18\u52BF\uFF1A"),n("table",null,[n("thead",null,[n("tr",null,[n("th",null,"\u65B9\u6CD5"),n("th",null,"65B \u6A21\u578B\u5185\u5B58\u5360\u7528"),n("th",null,"\u8BAD\u7EC3\u5185\u5B58\u5CF0\u503C"),n("th",null,"\u6700\u5C0F GPU \u8981\u6C42")])]),n("tbody",null,[n("tr",null,[n("td",null,"\u5168\u7CBE\u5EA6\u5FAE\u8C03"),n("td",null,"~260GB"),n("td",null,"~780GB"),n("td",null,"8\xD7A100 (80GB)")]),n("tr",null,[n("td",null,"16-bit LoRA"),n("td",null,"~130GB"),n("td",null,"~390GB"),n("td",null,"4\xD7A100 (80GB)")]),n("tr",null,[n("td",null,"QLoRA"),n("td",null,"~48GB"),n("td",null,"~95GB"),n("td",null,"1\xD7A100 (80GB)")])])]),n("h3",{id:"\u7CBE\u5EA6\u4FDD\u6301",tabindex:"-1"},[s("\u7CBE\u5EA6\u4FDD\u6301 "),n("a",{class:"header-anchor",href:"#\u7CBE\u5EA6\u4FDD\u6301","aria-hidden":"true"},"#")]),n("p",null,"QLoRA \u901A\u8FC7\u4EE5\u4E0B\u65B9\u5F0F\u4FDD\u6301\u8BAD\u7EC3\u7CBE\u5EA6\uFF1A"),n("ul",null,[n("li",null,[n("strong",null,"\u57FA\u7840\u6743\u91CD\u91CF\u5316"),s("\uFF1A\u4F7F\u7528\u7406\u8BBA\u6700\u4F18\u7684 NF4 \u683C\u5F0F")]),n("li",null,[n("strong",null,"\u9002\u914D\u5668\u9AD8\u7CBE\u5EA6"),s("\uFF1ALoRA \u6743\u91CD\u4FDD\u6301 16-bit \u7CBE\u5EA6")]),n("li",null,[n("strong",null,"\u68AF\u5EA6\u8BA1\u7B97"),s("\uFF1A\u5728 16-bit \u7CBE\u5EA6\u4E0B\u8FDB\u884C")])]),n("h2",{id:"\u5B9E\u9645\u5E94\u7528\u6848\u4F8B",tabindex:"-1"},[s("\u5B9E\u9645\u5E94\u7528\u6848\u4F8B "),n("a",{class:"header-anchor",href:"#\u5B9E\u9645\u5E94\u7528\u6848\u4F8B","aria-hidden":"true"},"#")]),n("h3",{id:"llama-2-7b-qlora-\u5FAE\u8C03",tabindex:"-1"},[s("Llama-2 7B QLoRA \u5FAE\u8C03 "),n("a",{class:"header-anchor",href:"#llama-2-7b-qlora-\u5FAE\u8C03","aria-hidden":"true"},"#")]),n("pre",{class:"language-python"},[n("code",{class:"language-python"},[n("span",{class:"token keyword"},"from"),s(" transformers "),n("span",{class:"token keyword"},"import"),s(" AutoModelForCausalLM"),n("span",{class:"token punctuation"},","),s(" AutoTokenizer"),n("span",{class:"token punctuation"},","),s(` TrainingArguments
`),n("span",{class:"token keyword"},"from"),s(" peft "),n("span",{class:"token keyword"},"import"),s(" LoraConfig"),n("span",{class:"token punctuation"},","),s(` get_peft_model
`),n("span",{class:"token keyword"},"from"),s(" datasets "),n("span",{class:"token keyword"},"import"),s(` load_dataset

`),n("span",{class:"token keyword"},"def"),s(),n("span",{class:"token function"},"finetune_llama2_qlora"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},":"),s(`
    `),n("span",{class:"token triple-quoted-string string"},'"""Llama-2 7B QLoRA \u5FAE\u8C03\u793A\u4F8B"""'),s(`

    model_name `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token string"},'"meta-llama/Llama-2-7b-hf"'),s(`

    `),n("span",{class:"token comment"},"# \u91CF\u5316\u914D\u7F6E"),s(`
    bnb_config `),n("span",{class:"token operator"},"="),s(" BitsAndBytesConfig"),n("span",{class:"token punctuation"},"("),s(`
        load_in_4bit`),n("span",{class:"token operator"},"="),n("span",{class:"token boolean"},"True"),n("span",{class:"token punctuation"},","),s(`
        bnb_4bit_quant_type`),n("span",{class:"token operator"},"="),n("span",{class:"token string"},'"nf4"'),n("span",{class:"token punctuation"},","),s(`
        bnb_4bit_use_double_quant`),n("span",{class:"token operator"},"="),n("span",{class:"token boolean"},"True"),n("span",{class:"token punctuation"},","),s(`
        bnb_4bit_compute_dtype`),n("span",{class:"token operator"},"="),s("torch"),n("span",{class:"token punctuation"},"."),s(`float16
    `),n("span",{class:"token punctuation"},")"),s(`

    `),n("span",{class:"token comment"},"# \u52A0\u8F7D\u6A21\u578B"),s(`
    model `),n("span",{class:"token operator"},"="),s(" AutoModelForCausalLM"),n("span",{class:"token punctuation"},"."),s("from_pretrained"),n("span",{class:"token punctuation"},"("),s(`
        model_name`),n("span",{class:"token punctuation"},","),s(`
        quantization_config`),n("span",{class:"token operator"},"="),s("bnb_config"),n("span",{class:"token punctuation"},","),s(`
        device_map`),n("span",{class:"token operator"},"="),n("span",{class:"token string"},'"auto"'),s(`
    `),n("span",{class:"token punctuation"},")"),s(`

    tokenizer `),n("span",{class:"token operator"},"="),s(" AutoTokenizer"),n("span",{class:"token punctuation"},"."),s("from_pretrained"),n("span",{class:"token punctuation"},"("),s("model_name"),n("span",{class:"token punctuation"},")"),s(`
    tokenizer`),n("span",{class:"token punctuation"},"."),s("pad_token "),n("span",{class:"token operator"},"="),s(" tokenizer"),n("span",{class:"token punctuation"},"."),s(`eos_token

    `),n("span",{class:"token comment"},"# LoRA \u914D\u7F6E"),s(`
    lora_config `),n("span",{class:"token operator"},"="),s(" LoraConfig"),n("span",{class:"token punctuation"},"("),s(`
        r`),n("span",{class:"token operator"},"="),n("span",{class:"token number"},"8"),n("span",{class:"token punctuation"},","),s(`
        lora_alpha`),n("span",{class:"token operator"},"="),n("span",{class:"token number"},"32"),n("span",{class:"token punctuation"},","),s(`
        target_modules`),n("span",{class:"token operator"},"="),n("span",{class:"token punctuation"},"["),s(`
            `),n("span",{class:"token string"},'"q_proj"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"k_proj"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"v_proj"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"o_proj"'),n("span",{class:"token punctuation"},","),s(`
            `),n("span",{class:"token string"},'"gate_proj"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"up_proj"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"down_proj"'),s(`
        `),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},","),s(`
        lora_dropout`),n("span",{class:"token operator"},"="),n("span",{class:"token number"},"0.1"),n("span",{class:"token punctuation"},","),s(`
        bias`),n("span",{class:"token operator"},"="),n("span",{class:"token string"},'"none"'),n("span",{class:"token punctuation"},","),s(`
        task_type`),n("span",{class:"token operator"},"="),n("span",{class:"token string"},'"CAUSAL_LM"'),s(`
    `),n("span",{class:"token punctuation"},")"),s(`

    model `),n("span",{class:"token operator"},"="),s(" get_peft_model"),n("span",{class:"token punctuation"},"("),s("model"),n("span",{class:"token punctuation"},","),s(" lora_config"),n("span",{class:"token punctuation"},")"),s(`

    `),n("span",{class:"token comment"},"# \u8BAD\u7EC3\u914D\u7F6E"),s(`
    training_args `),n("span",{class:"token operator"},"="),s(" TrainingArguments"),n("span",{class:"token punctuation"},"("),s(`
        output_dir`),n("span",{class:"token operator"},"="),n("span",{class:"token string"},'"./qlora-llama2-7b"'),n("span",{class:"token punctuation"},","),s(`
        num_train_epochs`),n("span",{class:"token operator"},"="),n("span",{class:"token number"},"3"),n("span",{class:"token punctuation"},","),s(`
        per_device_train_batch_size`),n("span",{class:"token operator"},"="),n("span",{class:"token number"},"4"),n("span",{class:"token punctuation"},","),s(`
        gradient_accumulation_steps`),n("span",{class:"token operator"},"="),n("span",{class:"token number"},"4"),n("span",{class:"token punctuation"},","),s(`
        learning_rate`),n("span",{class:"token operator"},"="),n("span",{class:"token number"},"2e-4"),n("span",{class:"token punctuation"},","),s(`
        weight_decay`),n("span",{class:"token operator"},"="),n("span",{class:"token number"},"0.01"),n("span",{class:"token punctuation"},","),s(`
        logging_steps`),n("span",{class:"token operator"},"="),n("span",{class:"token number"},"10"),n("span",{class:"token punctuation"},","),s(`
        save_steps`),n("span",{class:"token operator"},"="),n("span",{class:"token number"},"500"),n("span",{class:"token punctuation"},","),s(`
        fp16`),n("span",{class:"token operator"},"="),n("span",{class:"token boolean"},"True"),n("span",{class:"token punctuation"},","),s(`
    `),n("span",{class:"token punctuation"},")"),s(`

    `),n("span",{class:"token keyword"},"return"),s(" model"),n("span",{class:"token punctuation"},","),s(" tokenizer"),n("span",{class:"token punctuation"},","),s(` training_args
`)])]),n("h3",{id:"\u5BF9\u8BDD\u6A21\u578B\u5FAE\u8C03",tabindex:"-1"},[s("\u5BF9\u8BDD\u6A21\u578B\u5FAE\u8C03 "),n("a",{class:"header-anchor",href:"#\u5BF9\u8BDD\u6A21\u578B\u5FAE\u8C03","aria-hidden":"true"},"#")]),n("pre",{class:"language-python"},[n("code",{class:"language-python"},[n("span",{class:"token keyword"},"def"),s(),n("span",{class:"token function"},"create_qlora_chatbot"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},":"),s(`
    `),n("span",{class:"token triple-quoted-string string"},'"""\u521B\u5EFA QLoRA \u5BF9\u8BDD\u673A\u5668\u4EBA"""'),s(`

    model_name `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token string"},'"microsoft/DialoGPT-medium"'),s(`

    `),n("span",{class:"token comment"},"# QLoRA \u8BBE\u7F6E"),s(`
    bnb_config `),n("span",{class:"token operator"},"="),s(" BitsAndBytesConfig"),n("span",{class:"token punctuation"},"("),s(`
        load_in_4bit`),n("span",{class:"token operator"},"="),n("span",{class:"token boolean"},"True"),n("span",{class:"token punctuation"},","),s(`
        bnb_4bit_quant_type`),n("span",{class:"token operator"},"="),n("span",{class:"token string"},'"nf4"'),n("span",{class:"token punctuation"},","),s(`
        bnb_4bit_use_double_quant`),n("span",{class:"token operator"},"="),n("span",{class:"token boolean"},"True"),n("span",{class:"token punctuation"},","),s(`
        bnb_4bit_compute_dtype`),n("span",{class:"token operator"},"="),s("torch"),n("span",{class:"token punctuation"},"."),s(`float16
    `),n("span",{class:"token punctuation"},")"),s(`

    model `),n("span",{class:"token operator"},"="),s(" AutoModelForCausalLM"),n("span",{class:"token punctuation"},"."),s("from_pretrained"),n("span",{class:"token punctuation"},"("),s(`
        model_name`),n("span",{class:"token punctuation"},","),s(`
        quantization_config`),n("span",{class:"token operator"},"="),s("bnb_config"),n("span",{class:"token punctuation"},","),s(`
        device_map`),n("span",{class:"token operator"},"="),n("span",{class:"token string"},'"auto"'),s(`
    `),n("span",{class:"token punctuation"},")"),s(`

    `),n("span",{class:"token comment"},"# \u6DFB\u52A0\u9002\u914D\u5668"),s(`
    lora_config `),n("span",{class:"token operator"},"="),s(" LoraConfig"),n("span",{class:"token punctuation"},"("),s(`
        r`),n("span",{class:"token operator"},"="),n("span",{class:"token number"},"8"),n("span",{class:"token punctuation"},","),s(`
        lora_alpha`),n("span",{class:"token operator"},"="),n("span",{class:"token number"},"32"),n("span",{class:"token punctuation"},","),s(`
        target_modules`),n("span",{class:"token operator"},"="),n("span",{class:"token punctuation"},"["),n("span",{class:"token string"},'"c_attn"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"c_proj"'),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},","),s(`
        lora_dropout`),n("span",{class:"token operator"},"="),n("span",{class:"token number"},"0.1"),n("span",{class:"token punctuation"},","),s(`
        task_type`),n("span",{class:"token operator"},"="),n("span",{class:"token string"},'"CAUSAL_LM"'),s(`
    `),n("span",{class:"token punctuation"},")"),s(`

    model `),n("span",{class:"token operator"},"="),s(" get_peft_model"),n("span",{class:"token punctuation"},"("),s("model"),n("span",{class:"token punctuation"},","),s(" lora_config"),n("span",{class:"token punctuation"},")"),s(`
    tokenizer `),n("span",{class:"token operator"},"="),s(" AutoTokenizer"),n("span",{class:"token punctuation"},"."),s("from_pretrained"),n("span",{class:"token punctuation"},"("),s("model_name"),n("span",{class:"token punctuation"},")"),s(`

    `),n("span",{class:"token keyword"},"return"),s(" model"),n("span",{class:"token punctuation"},","),s(` tokenizer

`),n("span",{class:"token keyword"},"def"),s(),n("span",{class:"token function"},"chat_with_qlora_model"),n("span",{class:"token punctuation"},"("),s("model"),n("span",{class:"token punctuation"},","),s(" tokenizer"),n("span",{class:"token punctuation"},","),s(" prompt"),n("span",{class:"token punctuation"},","),s(" max_length"),n("span",{class:"token operator"},"="),n("span",{class:"token number"},"100"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},":"),s(`
    `),n("span",{class:"token triple-quoted-string string"},'"""\u4F7F\u7528 QLoRA \u6A21\u578B\u8FDB\u884C\u5BF9\u8BDD"""'),s(`
    inputs `),n("span",{class:"token operator"},"="),s(" tokenizer"),n("span",{class:"token punctuation"},"."),s("encode"),n("span",{class:"token punctuation"},"("),s("prompt "),n("span",{class:"token operator"},"+"),s(" tokenizer"),n("span",{class:"token punctuation"},"."),s("eos_token"),n("span",{class:"token punctuation"},","),s(" return_tensors"),n("span",{class:"token operator"},"="),n("span",{class:"token string"},'"pt"'),n("span",{class:"token punctuation"},")"),s(`

    `),n("span",{class:"token keyword"},"with"),s(" torch"),n("span",{class:"token punctuation"},"."),s("no_grad"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},":"),s(`
        outputs `),n("span",{class:"token operator"},"="),s(" model"),n("span",{class:"token punctuation"},"."),s("generate"),n("span",{class:"token punctuation"},"("),s(`
            inputs`),n("span",{class:"token punctuation"},","),s(`
            max_length`),n("span",{class:"token operator"},"="),s("max_length"),n("span",{class:"token punctuation"},","),s(`
            temperature`),n("span",{class:"token operator"},"="),n("span",{class:"token number"},"0.7"),n("span",{class:"token punctuation"},","),s(`
            do_sample`),n("span",{class:"token operator"},"="),n("span",{class:"token boolean"},"True"),n("span",{class:"token punctuation"},","),s(`
            pad_token_id`),n("span",{class:"token operator"},"="),s("tokenizer"),n("span",{class:"token punctuation"},"."),s(`eos_token_id
        `),n("span",{class:"token punctuation"},")"),s(`

    response `),n("span",{class:"token operator"},"="),s(" tokenizer"),n("span",{class:"token punctuation"},"."),s("decode"),n("span",{class:"token punctuation"},"("),s("outputs"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},","),s(" skip_special_tokens"),n("span",{class:"token operator"},"="),n("span",{class:"token boolean"},"True"),n("span",{class:"token punctuation"},")"),s(`
    `),n("span",{class:"token keyword"},"return"),s(" response"),n("span",{class:"token punctuation"},"["),n("span",{class:"token builtin"},"len"),n("span",{class:"token punctuation"},"("),s("prompt"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},":"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},"."),s("strip"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(`
`)])]),n("h2",{id:"\u6700\u4F73\u5B9E\u8DF5",tabindex:"-1"},[s("\u6700\u4F73\u5B9E\u8DF5 "),n("a",{class:"header-anchor",href:"#\u6700\u4F73\u5B9E\u8DF5","aria-hidden":"true"},"#")]),n("h3",{id:"\u8D85\u53C2\u6570\u8C03\u4F18",tabindex:"-1"},[s("\u8D85\u53C2\u6570\u8C03\u4F18 "),n("a",{class:"header-anchor",href:"#\u8D85\u53C2\u6570\u8C03\u4F18","aria-hidden":"true"},"#")]),n("p",null,"\u6839\u636E\u4E0D\u540C\u6761\u4EF6\u63A8\u8350\u7684 QLoRA \u914D\u7F6E\uFF1A"),n("pre",{class:"language-python"},[n("code",{class:"language-python"},[n("span",{class:"token keyword"},"def"),s(),n("span",{class:"token function"},"get_qlora_config"),n("span",{class:"token punctuation"},"("),s("model_size"),n("span",{class:"token punctuation"},","),s(" gpu_memory_gb"),n("span",{class:"token punctuation"},","),s(" task_type"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},":"),s(`
    `),n("span",{class:"token triple-quoted-string string"},'"""\u83B7\u53D6\u63A8\u8350\u7684 QLoRA \u914D\u7F6E"""'),s(`

    base_configs `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token punctuation"},"{"),s(`
        `),n("span",{class:"token string"},"'small_model'"),n("span",{class:"token punctuation"},":"),s(),n("span",{class:"token punctuation"},"{"),s("  "),n("span",{class:"token comment"},"# < 7B"),s(`
            `),n("span",{class:"token string"},"'r'"),n("span",{class:"token punctuation"},":"),s(),n("span",{class:"token number"},"16"),n("span",{class:"token punctuation"},","),s(`
            `),n("span",{class:"token string"},"'lora_alpha'"),n("span",{class:"token punctuation"},":"),s(),n("span",{class:"token number"},"32"),n("span",{class:"token punctuation"},","),s(`
            `),n("span",{class:"token string"},"'batch_size'"),n("span",{class:"token punctuation"},":"),s(),n("span",{class:"token number"},"8"),n("span",{class:"token punctuation"},","),s(`
            `),n("span",{class:"token string"},"'gradient_accumulation_steps'"),n("span",{class:"token punctuation"},":"),s(),n("span",{class:"token number"},"4"),s(`
        `),n("span",{class:"token punctuation"},"}"),n("span",{class:"token punctuation"},","),s(`
        `),n("span",{class:"token string"},"'medium_model'"),n("span",{class:"token punctuation"},":"),s(),n("span",{class:"token punctuation"},"{"),s("  "),n("span",{class:"token comment"},"# 7B-30B"),s(`
            `),n("span",{class:"token string"},"'r'"),n("span",{class:"token punctuation"},":"),s(),n("span",{class:"token number"},"8"),n("span",{class:"token punctuation"},","),s(`
            `),n("span",{class:"token string"},"'lora_alpha'"),n("span",{class:"token punctuation"},":"),s(),n("span",{class:"token number"},"32"),n("span",{class:"token punctuation"},","),s(`
            `),n("span",{class:"token string"},"'batch_size'"),n("span",{class:"token punctuation"},":"),s(),n("span",{class:"token number"},"4"),n("span",{class:"token punctuation"},","),s(`
            `),n("span",{class:"token string"},"'gradient_accumulation_steps'"),n("span",{class:"token punctuation"},":"),s(),n("span",{class:"token number"},"8"),s(`
        `),n("span",{class:"token punctuation"},"}"),n("span",{class:"token punctuation"},","),s(`
        `),n("span",{class:"token string"},"'large_model'"),n("span",{class:"token punctuation"},":"),s(),n("span",{class:"token punctuation"},"{"),s("  "),n("span",{class:"token comment"},"# > 30B"),s(`
            `),n("span",{class:"token string"},"'r'"),n("span",{class:"token punctuation"},":"),s(),n("span",{class:"token number"},"4"),n("span",{class:"token punctuation"},","),s(`
            `),n("span",{class:"token string"},"'lora_alpha'"),n("span",{class:"token punctuation"},":"),s(),n("span",{class:"token number"},"16"),n("span",{class:"token punctuation"},","),s(`
            `),n("span",{class:"token string"},"'batch_size'"),n("span",{class:"token punctuation"},":"),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},","),s(`
            `),n("span",{class:"token string"},"'gradient_accumulation_steps'"),n("span",{class:"token punctuation"},":"),s(),n("span",{class:"token number"},"32"),s(`
        `),n("span",{class:"token punctuation"},"}"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`

    `),n("span",{class:"token keyword"},"if"),s(" model_size "),n("span",{class:"token operator"},"<"),s(),n("span",{class:"token number"},"7e9"),n("span",{class:"token punctuation"},":"),s(`
        config `),n("span",{class:"token operator"},"="),s(" base_configs"),n("span",{class:"token punctuation"},"["),n("span",{class:"token string"},"'small_model'"),n("span",{class:"token punctuation"},"]"),s(`
    `),n("span",{class:"token keyword"},"elif"),s(" model_size "),n("span",{class:"token operator"},"<"),s(),n("span",{class:"token number"},"30e9"),n("span",{class:"token punctuation"},":"),s(`
        config `),n("span",{class:"token operator"},"="),s(" base_configs"),n("span",{class:"token punctuation"},"["),n("span",{class:"token string"},"'medium_model'"),n("span",{class:"token punctuation"},"]"),s(`
    `),n("span",{class:"token keyword"},"else"),n("span",{class:"token punctuation"},":"),s(`
        config `),n("span",{class:"token operator"},"="),s(" base_configs"),n("span",{class:"token punctuation"},"["),n("span",{class:"token string"},"'large_model'"),n("span",{class:"token punctuation"},"]"),s(`

    `),n("span",{class:"token comment"},"# \u6839\u636E GPU \u5185\u5B58\u8C03\u6574"),s(`
    `),n("span",{class:"token keyword"},"if"),s(" gpu_memory_gb "),n("span",{class:"token operator"},"<"),s(),n("span",{class:"token number"},"16"),n("span",{class:"token punctuation"},":"),s(`
        config`),n("span",{class:"token punctuation"},"["),n("span",{class:"token string"},"'batch_size'"),n("span",{class:"token punctuation"},"]"),s(),n("span",{class:"token operator"},"="),s(),n("span",{class:"token builtin"},"max"),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},","),s(" config"),n("span",{class:"token punctuation"},"["),n("span",{class:"token string"},"'batch_size'"),n("span",{class:"token punctuation"},"]"),s(),n("span",{class:"token operator"},"//"),s(),n("span",{class:"token number"},"2"),n("span",{class:"token punctuation"},")"),s(`
        config`),n("span",{class:"token punctuation"},"["),n("span",{class:"token string"},"'gradient_accumulation_steps'"),n("span",{class:"token punctuation"},"]"),s(),n("span",{class:"token operator"},"*="),s(),n("span",{class:"token number"},"2"),s(`

    `),n("span",{class:"token keyword"},"return"),s(` config
`)])]),n("h3",{id:"\u8BAD\u7EC3\u76D1\u63A7",tabindex:"-1"},[s("\u8BAD\u7EC3\u76D1\u63A7 "),n("a",{class:"header-anchor",href:"#\u8BAD\u7EC3\u76D1\u63A7","aria-hidden":"true"},"#")]),n("pre",{class:"language-python"},[n("code",{class:"language-python"},[n("span",{class:"token keyword"},"class"),s(),n("span",{class:"token class-name"},"QLoRATrainingMonitor"),n("span",{class:"token punctuation"},":"),s(`
    `),n("span",{class:"token triple-quoted-string string"},'"""QLoRA \u8BAD\u7EC3\u76D1\u63A7"""'),s(`

    `),n("span",{class:"token keyword"},"def"),s(),n("span",{class:"token function"},"__init__"),n("span",{class:"token punctuation"},"("),s("self"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},":"),s(`
        self`),n("span",{class:"token punctuation"},"."),s("metrics "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token punctuation"},"{"),s(`
            `),n("span",{class:"token string"},"'gpu_memory'"),n("span",{class:"token punctuation"},":"),s(),n("span",{class:"token punctuation"},"["),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},","),s(`
            `),n("span",{class:"token string"},"'loss'"),n("span",{class:"token punctuation"},":"),s(),n("span",{class:"token punctuation"},"["),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},","),s(`
            `),n("span",{class:"token string"},"'learning_rate'"),n("span",{class:"token punctuation"},":"),s(),n("span",{class:"token punctuation"},"["),n("span",{class:"token punctuation"},"]"),s(`
        `),n("span",{class:"token punctuation"},"}"),s(`

    `),n("span",{class:"token keyword"},"def"),s(),n("span",{class:"token function"},"log_step"),n("span",{class:"token punctuation"},"("),s("self"),n("span",{class:"token punctuation"},","),s(" loss"),n("span",{class:"token punctuation"},","),s(" lr"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},":"),s(`
        `),n("span",{class:"token triple-quoted-string string"},'"""\u8BB0\u5F55\u8BAD\u7EC3\u6B65\u9AA4"""'),s(`
        `),n("span",{class:"token comment"},"# GPU \u5185\u5B58\u4F7F\u7528"),s(`
        `),n("span",{class:"token keyword"},"if"),s(" torch"),n("span",{class:"token punctuation"},"."),s("cuda"),n("span",{class:"token punctuation"},"."),s("is_available"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},":"),s(`
            memory_used `),n("span",{class:"token operator"},"="),s(" torch"),n("span",{class:"token punctuation"},"."),s("cuda"),n("span",{class:"token punctuation"},"."),s("memory_allocated"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"/"),s(),n("span",{class:"token number"},"1024"),n("span",{class:"token operator"},"**"),n("span",{class:"token number"},"3"),s("  "),n("span",{class:"token comment"},"# GB"),s(`
            self`),n("span",{class:"token punctuation"},"."),s("metrics"),n("span",{class:"token punctuation"},"["),n("span",{class:"token string"},"'gpu_memory'"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},"."),s("append"),n("span",{class:"token punctuation"},"("),s("memory_used"),n("span",{class:"token punctuation"},")"),s(`

        self`),n("span",{class:"token punctuation"},"."),s("metrics"),n("span",{class:"token punctuation"},"["),n("span",{class:"token string"},"'loss'"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},"."),s("append"),n("span",{class:"token punctuation"},"("),s("loss"),n("span",{class:"token punctuation"},")"),s(`
        self`),n("span",{class:"token punctuation"},"."),s("metrics"),n("span",{class:"token punctuation"},"["),n("span",{class:"token string"},"'learning_rate'"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},"."),s("append"),n("span",{class:"token punctuation"},"("),s("lr"),n("span",{class:"token punctuation"},")"),s(`

    `),n("span",{class:"token keyword"},"def"),s(),n("span",{class:"token function"},"print_summary"),n("span",{class:"token punctuation"},"("),s("self"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},":"),s(`
        `),n("span",{class:"token triple-quoted-string string"},'"""\u6253\u5370\u8BAD\u7EC3\u6458\u8981"""'),s(`
        `),n("span",{class:"token keyword"},"print"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"\\n=== QLoRA \u8BAD\u7EC3\u76D1\u63A7\u6458\u8981 ==="'),n("span",{class:"token punctuation"},")"),s(`

        `),n("span",{class:"token keyword"},"if"),s(" self"),n("span",{class:"token punctuation"},"."),s("metrics"),n("span",{class:"token punctuation"},"["),n("span",{class:"token string"},"'gpu_memory'"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},":"),s(`
            avg_memory `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token builtin"},"sum"),n("span",{class:"token punctuation"},"("),s("self"),n("span",{class:"token punctuation"},"."),s("metrics"),n("span",{class:"token punctuation"},"["),n("span",{class:"token string"},"'gpu_memory'"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"/"),s(),n("span",{class:"token builtin"},"len"),n("span",{class:"token punctuation"},"("),s("self"),n("span",{class:"token punctuation"},"."),s("metrics"),n("span",{class:"token punctuation"},"["),n("span",{class:"token string"},"'gpu_memory'"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),s(`
            max_memory `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token builtin"},"max"),n("span",{class:"token punctuation"},"("),s("self"),n("span",{class:"token punctuation"},"."),s("metrics"),n("span",{class:"token punctuation"},"["),n("span",{class:"token string"},"'gpu_memory'"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),s(`
            `),n("span",{class:"token keyword"},"print"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string-interpolation"},[n("span",{class:"token string"},'f"GPU \u5185\u5B58\u4F7F\u7528: \u5E73\u5747 '),n("span",{class:"token interpolation"},[n("span",{class:"token punctuation"},"{"),s("avg_memory"),n("span",{class:"token punctuation"},":"),n("span",{class:"token format-spec"},".1f"),n("span",{class:"token punctuation"},"}")]),n("span",{class:"token string"},"GB, \u5CF0\u503C "),n("span",{class:"token interpolation"},[n("span",{class:"token punctuation"},"{"),s("max_memory"),n("span",{class:"token punctuation"},":"),n("span",{class:"token format-spec"},".1f"),n("span",{class:"token punctuation"},"}")]),n("span",{class:"token string"},'GB"')]),n("span",{class:"token punctuation"},")"),s(`

        `),n("span",{class:"token keyword"},"if"),s(" self"),n("span",{class:"token punctuation"},"."),s("metrics"),n("span",{class:"token punctuation"},"["),n("span",{class:"token string"},"'loss'"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},":"),s(`
            initial_loss `),n("span",{class:"token operator"},"="),s(" self"),n("span",{class:"token punctuation"},"."),s("metrics"),n("span",{class:"token punctuation"},"["),n("span",{class:"token string"},"'loss'"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},"]"),s(`
            final_loss `),n("span",{class:"token operator"},"="),s(" self"),n("span",{class:"token punctuation"},"."),s("metrics"),n("span",{class:"token punctuation"},"["),n("span",{class:"token string"},"'loss'"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},"["),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},"]"),s(`
            `),n("span",{class:"token keyword"},"print"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string-interpolation"},[n("span",{class:"token string"},'f"\u635F\u5931\u53D8\u5316: '),n("span",{class:"token interpolation"},[n("span",{class:"token punctuation"},"{"),s("initial_loss"),n("span",{class:"token punctuation"},":"),n("span",{class:"token format-spec"},".4f"),n("span",{class:"token punctuation"},"}")]),n("span",{class:"token string"}," \u2192 "),n("span",{class:"token interpolation"},[n("span",{class:"token punctuation"},"{"),s("final_loss"),n("span",{class:"token punctuation"},":"),n("span",{class:"token format-spec"},".4f"),n("span",{class:"token punctuation"},"}")]),n("span",{class:"token string"},'"')]),n("span",{class:"token punctuation"},")"),s(`
`)])]),n("h2",{id:"\u603B\u7ED3",tabindex:"-1"},[s("\u603B\u7ED3 "),n("a",{class:"header-anchor",href:"#\u603B\u7ED3","aria-hidden":"true"},"#")]),n("h3",{id:"qlora-\u7684\u4F18\u52BF\u4E0E\u5C40\u9650",tabindex:"-1"},[s("QLoRA \u7684\u4F18\u52BF\u4E0E\u5C40\u9650 "),n("a",{class:"header-anchor",href:"#qlora-\u7684\u4F18\u52BF\u4E0E\u5C40\u9650","aria-hidden":"true"},"#")]),n("p",null,[n("strong",null,"\u4F18\u52BF\uFF1A")]),n("ol",null,[n("li",null,[n("strong",null,"\u6781\u4F4E\u5185\u5B58\u5360\u7528"),s("\uFF1A4-bit \u91CF\u5316\u5927\u5E45\u51CF\u5C11\u5185\u5B58\u9700\u6C42")]),n("li",null,[n("strong",null,"\u786C\u4EF6\u53CB\u597D"),s("\uFF1A\u6D88\u8D39\u7EA7 GPU \u53EF\u8BAD\u7EC3\u5927\u6A21\u578B")]),n("li",null,[n("strong",null,"\u7CBE\u5EA6\u4FDD\u6301"),s("\uFF1A\u63A5\u8FD1\u5168\u7CBE\u5EA6\u8BAD\u7EC3\u6548\u679C")]),n("li",null,[n("strong",null,"\u90E8\u7F72\u4FBF\u5229"),s("\uFF1A\u91CF\u5316\u6A21\u578B\u4FBF\u4E8E\u90E8\u7F72\u548C\u5206\u53D1")])]),n("p",null,[n("strong",null,"\u5C40\u9650\uFF1A")]),n("ol",null,[n("li",null,[n("strong",null,"\u91CF\u5316\u635F\u5931"),s("\uFF1A\u867D\u7136\u5F88\u5C0F\uFF0C\u4F46\u4ECD\u5B58\u5728\u7CBE\u5EA6\u635F\u5931")]),n("li",null,[n("strong",null,"\u8BA1\u7B97\u5F00\u9500"),s("\uFF1A\u53CD\u91CF\u5316\u8FC7\u7A0B\u589E\u52A0\u8BA1\u7B97\u8D1F\u62C5")]),n("li",null,[n("strong",null,"\u786C\u4EF6\u4F9D\u8D56"),s("\uFF1A\u9700\u8981\u652F\u6301 4-bit \u8FD0\u7B97\u7684\u786C\u4EF6")]),n("li",null,[n("strong",null,"\u8C03\u4F18\u590D\u6742"),s("\uFF1A\u91CF\u5316\u548C LoRA \u53C2\u6570\u90FD\u9700\u8981\u8C03\u4F18")])]),n("h3",{id:"\u76F8\u5173\u8D44\u6E90",tabindex:"-1"},[s("\u76F8\u5173\u8D44\u6E90 "),n("a",{class:"header-anchor",href:"#\u76F8\u5173\u8D44\u6E90","aria-hidden":"true"},"#")]),n("ul",null,[n("li",null,[n("strong",null,"\u8BBA\u6587\u5730\u5740"),s("\uFF1A"),n("a",{href:"https://arxiv.org/abs/2305.14314",target:"_blank",rel:"noopener"},"QLoRA: Efficient Finetuning of Quantized LLMs")]),n("li",null,[n("strong",null,"\u5B98\u65B9\u5B9E\u73B0"),s("\uFF1A"),n("a",{href:"https://github.com/artidoro/qlora",target:"_blank",rel:"noopener"},"QLoRA GitHub")]),n("li",null,[n("strong",null,"BitsAndBytes \u5E93"),s("\uFF1A"),n("a",{href:"https://github.com/TimDettmers/bitsandbytes",target:"_blank",rel:"noopener"},"BitsAndBytes")]),n("li",null,[n("strong",null,"PEFT \u5E93"),s("\uFF1A"),n("a",{href:"https://github.com/huggingface/peft",target:"_blank",rel:"noopener"},"Hugging Face PEFT")])]),n("hr"),n("p",null,"QLoRA \u4F5C\u4E3A LoRA \u7684\u8FDB\u4E00\u6B65\u4F18\u5316\uFF0C\u901A\u8FC7\u91CF\u5316\u6280\u672F\u5B9E\u73B0\u4E86\u5728\u6709\u9650\u786C\u4EF6\u8D44\u6E90\u4E0B\u8BAD\u7EC3\u5927\u578B\u8BED\u8A00\u6A21\u578B\u7684\u7A81\u7834\u3002\u5B83\u4E0D\u4EC5\u964D\u4F4E\u4E86\u5927\u6A21\u578B\u5FAE\u8C03\u7684\u95E8\u69DB\uFF0C\u4E5F\u4E3A\u4E2A\u4EBA\u7814\u7A76\u8005\u548C\u5C0F\u578B\u56E2\u961F\u63D0\u4F9B\u4E86\u53C2\u4E0E\u5927\u6A21\u578B\u7814\u7A76\u7684\u673A\u4F1A\u3002\u968F\u7740\u6280\u672F\u7684\u4E0D\u65AD\u53D1\u5C55\uFF0CQLoRA \u5C06\u5728\u5927\u6A21\u578B\u6C11\u4E3B\u5316\u8FDB\u7A0B\u4E2D\u53D1\u6325\u91CD\u8981\u4F5C\u7528\u3002")],-1)])]),_:1})}}};export{b as date,y as default,h as meta,_ as title,f as type};
