import{_ as l}from"./Post.14d9d5ce.js";import{u as c,c as p,w as r,o as u,a as n,b as s}from"./app.95384a36.js";var i="/images/notes/llm/mixed-precision/training-iteration.webp";const g="\u8BAD\u7EC3\u4F18\u5316\u6280\u672F\uFF1A\u6DF7\u5408\u7CBE\u5EA6\u8BAD\u7EC3\uFF08Mixed Precision Training\uFF09",y="2025-08-10T00:00:00.000Z",w="llm",b=[{property:"og:title",content:"\u8BAD\u7EC3\u4F18\u5316\u6280\u672F\uFF1A\u6DF7\u5408\u7CBE\u5EA6\u8BAD\u7EC3\uFF08Mixed Precision Training\uFF09"}],_={__name:"Model-training-optimization-mix",setup(k,{expose:o}){const a={title:"\u8BAD\u7EC3\u4F18\u5316\u6280\u672F\uFF1A\u6DF7\u5408\u7CBE\u5EA6\u8BAD\u7EC3\uFF08Mixed Precision Training\uFF09",date:"2025-08-10T00:00:00.000Z",type:"llm",meta:[{property:"og:title",content:"\u8BAD\u7EC3\u4F18\u5316\u6280\u672F\uFF1A\u6DF7\u5408\u7CBE\u5EA6\u8BAD\u7EC3\uFF08Mixed Precision Training\uFF09"}]};return o({frontmatter:a}),c({title:"\u8BAD\u7EC3\u4F18\u5316\u6280\u672F\uFF1A\u6DF7\u5408\u7CBE\u5EA6\u8BAD\u7EC3\uFF08Mixed Precision Training\uFF09",meta:[{property:"og:title",content:"\u8BAD\u7EC3\u4F18\u5316\u6280\u672F\uFF1A\u6DF7\u5408\u7CBE\u5EA6\u8BAD\u7EC3\uFF08Mixed Precision Training\uFF09"}]}),(h,t)=>{const e=l;return u(),p(e,{frontmatter:a},{default:r(()=>[...t[0]||(t[0]=[n("div",{class:"prose m-auto"},[n("h2",{id:"\u6DF7\u5408\u7CBE\u5EA6\u8BAD\u7EC3\u6982\u8FF0",tabindex:"-1"},[s("\u6DF7\u5408\u7CBE\u5EA6\u8BAD\u7EC3\u6982\u8FF0 "),n("a",{class:"header-anchor",href:"#\u6DF7\u5408\u7CBE\u5EA6\u8BAD\u7EC3\u6982\u8FF0","aria-hidden":"true"},"#")]),n("p",null,"\u6DF7\u5408\u7CBE\u5EA6\u8BAD\u7EC3\uFF08Mixed Precision Training\uFF09\u662F\u4E00\u79CD\u6DF1\u5EA6\u5B66\u4E60\u8BAD\u7EC3\u4F18\u5316\u6280\u672F\uFF0C\u901A\u8FC7\u5728\u8BAD\u7EC3\u8FC7\u7A0B\u4E2D\u540C\u65F6\u4F7F\u7528 16 \u4F4D\u6D6E\u70B9\u6570\uFF08FP16\uFF09\u548C 32 \u4F4D\u6D6E\u70B9\u6570\uFF08FP32\uFF09\u6765\u63D0\u5347\u8BAD\u7EC3\u6548\u7387\uFF0C\u540C\u65F6\u4FDD\u6301\u6A21\u578B\u7CBE\u5EA6\u3002"),n("h2",{id:"\u6838\u5FC3\u6982\u5FF5",tabindex:"-1"},[s("\u6838\u5FC3\u6982\u5FF5 "),n("a",{class:"header-anchor",href:"#\u6838\u5FC3\u6982\u5FF5","aria-hidden":"true"},"#")]),n("h3",{id:"\u6570\u503C\u7CBE\u5EA6\u7C7B\u578B",tabindex:"-1"},[s("\u6570\u503C\u7CBE\u5EA6\u7C7B\u578B "),n("a",{class:"header-anchor",href:"#\u6570\u503C\u7CBE\u5EA6\u7C7B\u578B","aria-hidden":"true"},"#")]),n("ul",null,[n("li",null,[n("strong",null,"FP32\uFF08\u5355\u7CBE\u5EA6\u6D6E\u70B9\uFF09"),s("\uFF1A32 \u4F4D\u6D6E\u70B9\u6570\uFF0C\u6807\u51C6\u8BAD\u7EC3\u7CBE\u5EA6")]),n("li",null,[n("strong",null,"FP16\uFF08\u534A\u7CBE\u5EA6\u6D6E\u70B9\uFF09"),s("\uFF1A16 \u4F4D\u6D6E\u70B9\u6570\uFF0C\u5185\u5B58\u5360\u7528\u51CF\u534A\uFF0C\u8BA1\u7B97\u901F\u5EA6\u66F4\u5FEB")]),n("li",null,[n("strong",null,"BF16\uFF08Brain Float 16\uFF09"),s("\uFF1A16 \u4F4D\u6D6E\u70B9\u6570\uFF0C\u52A8\u6001\u8303\u56F4\u4E0E FP32 \u76F8\u540C")])]),n("h3",{id:"\u4E3B\u8981\u4F18\u52BF",tabindex:"-1"},[s("\u4E3B\u8981\u4F18\u52BF "),n("a",{class:"header-anchor",href:"#\u4E3B\u8981\u4F18\u52BF","aria-hidden":"true"},"#")]),n("ol",null,[n("li",null,[n("strong",null,"\u5185\u5B58\u6548\u7387"),s("\uFF1A\u51CF\u5C11\u7EA6 50%\u7684 GPU \u663E\u5B58\u5360\u7528")]),n("li",null,[n("strong",null,"\u8BA1\u7B97\u901F\u5EA6"),s("\uFF1A\u5728\u652F\u6301 Tensor Core \u7684 GPU \u4E0A\u53EF\u83B7\u5F97 1.5-2 \u500D\u52A0\u901F")]),n("li",null,[n("strong",null,"\u8BAD\u7EC3\u7A33\u5B9A\u6027"),s("\uFF1A\u901A\u8FC7\u635F\u5931\u7F29\u653E\u6280\u672F\u4FDD\u6301\u8BAD\u7EC3\u7A33\u5B9A\u6027")])]),n("h2",{id:"\u6280\u672F\u539F\u7406",tabindex:"-1"},[s("\u6280\u672F\u539F\u7406 "),n("a",{class:"header-anchor",href:"#\u6280\u672F\u539F\u7406","aria-hidden":"true"},"#")]),n("h3",{id:"\u524D\u5411\u4F20\u64AD",tabindex:"-1"},[s("\u524D\u5411\u4F20\u64AD "),n("a",{class:"header-anchor",href:"#\u524D\u5411\u4F20\u64AD","aria-hidden":"true"},"#")]),n("pre",{class:"language-python"},[n("code",{class:"language-python"},[n("span",{class:"token comment"},"# \u4F2A\u4EE3\u7801\u793A\u4F8B"),s(`
`),n("span",{class:"token keyword"},"def"),s(),n("span",{class:"token function"},"forward_pass_mixed_precision"),n("span",{class:"token punctuation"},"("),s("model"),n("span",{class:"token punctuation"},","),s(" inputs"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},":"),s(`
    `),n("span",{class:"token comment"},"# \u8F93\u5165\u8F6C\u6362\u4E3AFP16"),s(`
    inputs_fp16 `),n("span",{class:"token operator"},"="),s(" inputs"),n("span",{class:"token punctuation"},"."),s("half"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(`

    `),n("span",{class:"token comment"},"# \u5927\u90E8\u5206\u5C42\u4F7F\u7528FP16\u8BA1\u7B97"),s(`
    `),n("span",{class:"token keyword"},"with"),s(" autocast"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},":"),s(`
        logits `),n("span",{class:"token operator"},"="),s(" model"),n("span",{class:"token punctuation"},"("),s("inputs_fp16"),n("span",{class:"token punctuation"},")"),s(`

    `),n("span",{class:"token comment"},"# \u635F\u5931\u8BA1\u7B97\u4F7F\u7528FP32\u4FDD\u8BC1\u7CBE\u5EA6"),s(`
    loss `),n("span",{class:"token operator"},"="),s(" loss_function"),n("span",{class:"token punctuation"},"("),s("logits"),n("span",{class:"token punctuation"},"."),n("span",{class:"token builtin"},"float"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},","),s(" targets"),n("span",{class:"token punctuation"},"."),n("span",{class:"token builtin"},"float"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(`

    `),n("span",{class:"token keyword"},"return"),s(` loss
`)])]),n("h3",{id:"\u68AF\u5EA6\u7F29\u653E\uFF08gradient-scaling\uFF09",tabindex:"-1"},[s("\u68AF\u5EA6\u7F29\u653E\uFF08Gradient Scaling\uFF09 "),n("a",{class:"header-anchor",href:"#\u68AF\u5EA6\u7F29\u653E\uFF08gradient-scaling\uFF09","aria-hidden":"true"},"#")]),n("p",null,"\u7531\u4E8E FP16 \u7684\u6570\u503C\u8303\u56F4\u8F83\u5C0F\uFF0C\u5C0F\u68AF\u5EA6\u53EF\u80FD\u4F1A underflow \u4E3A 0\u3002\u68AF\u5EA6\u7F29\u653E\u6280\u672F\u89E3\u51B3\u8FD9\u4E2A\u95EE\u9898\uFF1A"),n("pre",{class:"language-mermaid"},[n("code",{class:"language-mermaid"},[n("span",{class:"token keyword"},"graph"),s(` LR
    A`),n("span",{class:"token text string"},"[\u8F93\u5165\u6570\u636E]"),s(),n("span",{class:"token arrow operator"},"-->"),s(" B"),n("span",{class:"token text string"},"[\u524D\u5411\u4F20\u64AD<br/>FP16\u8BA1\u7B97]"),s(`
    B `),n("span",{class:"token arrow operator"},"-->"),s(" C"),n("span",{class:"token text string"},"[\u635F\u5931\u8BA1\u7B97<br/>FP32]"),s(`
    C `),n("span",{class:"token arrow operator"},"-->"),s(" D"),n("span",{class:"token text string"},"[\u635F\u5931\u7F29\u653E<br/>loss \xD7 scale_factor]"),s(`
    D `),n("span",{class:"token arrow operator"},"-->"),s(" E"),n("span",{class:"token text string"},"[\u53CD\u5411\u4F20\u64AD<br/>\u68AF\u5EA6\u653E\u5927]"),s(`
    E `),n("span",{class:"token arrow operator"},"-->"),s(" F"),n("span",{class:"token text string"},"[\u68C0\u67E5\u68AF\u5EA6\u6EA2\u51FA<br/>Inf/NaN\u68C0\u6D4B]"),s(`

    F `),n("span",{class:"token arrow operator"},"-->"),n("span",{class:"token label property"},"|\u65E0\u6EA2\u51FA|"),s(" G"),n("span",{class:"token text string"},"[\u68AF\u5EA6\u53CD\u7F29\u653E<br/>grad \xF7 scale_factor]"),s(`
    F `),n("span",{class:"token arrow operator"},"-->"),n("span",{class:"token label property"},"|\u6709\u6EA2\u51FA|"),s(" H"),n("span",{class:"token text string"},"[\u8DF3\u8FC7\u66F4\u65B0<br/>\u8C03\u6574\u7F29\u653E\u56E0\u5B50]"),s(`

    G `),n("span",{class:"token arrow operator"},"-->"),s(" I"),n("span",{class:"token text string"},"[\u53C2\u6570\u66F4\u65B0<br/>optimizer.step]"),s(`
    H `),n("span",{class:"token arrow operator"},"-->"),s(" J"),n("span",{class:"token text string"},"[\u4E0B\u4E00\u4E2A\u6279\u6B21]"),s(`
    I `),n("span",{class:"token arrow operator"},"-->"),s(` J

    `),n("span",{class:"token keyword"},"style"),s(" D "),n("span",{class:"token style"},[n("span",{class:"token property"},"fill"),n("span",{class:"token operator"},":"),s("#ffeb3b")]),s(`
    `),n("span",{class:"token keyword"},"style"),s(" F "),n("span",{class:"token style"},[n("span",{class:"token property"},"fill"),n("span",{class:"token operator"},":"),s("#ff9800")]),s(`
    `),n("span",{class:"token keyword"},"style"),s(" G "),n("span",{class:"token style"},[n("span",{class:"token property"},"fill"),n("span",{class:"token operator"},":"),s("#4caf50")]),s(`
    `),n("span",{class:"token keyword"},"style"),s(" H "),n("span",{class:"token style"},[n("span",{class:"token property"},"fill"),n("span",{class:"token operator"},":"),s("#f44336")]),s(`
`)])]),n("p",null,"\u4E3B\u8981\u6B65\u9AA4\uFF1A"),n("ol",null,[n("li",null,[n("strong",null,"\u524D\u5411\u4F20\u64AD"),s("\uFF1A\u635F\u5931\u4E58\u4EE5\u7F29\u653E\u56E0\u5B50")]),n("li",null,[n("strong",null,"\u53CD\u5411\u4F20\u64AD"),s("\uFF1A\u68AF\u5EA6\u88AB\u76F8\u5E94\u653E\u5927")]),n("li",null,[n("strong",null,"\u53C2\u6570\u66F4\u65B0"),s("\uFF1A\u68AF\u5EA6\u9664\u4EE5\u7F29\u653E\u56E0\u5B50\u6062\u590D\u539F\u59CB\u5927\u5C0F")])]),n("pre",{class:"language-python"},[n("code",{class:"language-python"},[n("span",{class:"token comment"},"# PyTorch\u5B9E\u73B0\u793A\u4F8B"),s(`
scaler `),n("span",{class:"token operator"},"="),s(" GradScaler"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(`

`),n("span",{class:"token keyword"},"def"),s(),n("span",{class:"token function"},"training_step"),n("span",{class:"token punctuation"},"("),s("model"),n("span",{class:"token punctuation"},","),s(" optimizer"),n("span",{class:"token punctuation"},","),s(" inputs"),n("span",{class:"token punctuation"},","),s(" targets"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},":"),s(`
    optimizer`),n("span",{class:"token punctuation"},"."),s("zero_grad"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(`

    `),n("span",{class:"token keyword"},"with"),s(" autocast"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},":"),s(`
        outputs `),n("span",{class:"token operator"},"="),s(" model"),n("span",{class:"token punctuation"},"("),s("inputs"),n("span",{class:"token punctuation"},")"),s(`
        loss `),n("span",{class:"token operator"},"="),s(" criterion"),n("span",{class:"token punctuation"},"("),s("outputs"),n("span",{class:"token punctuation"},","),s(" targets"),n("span",{class:"token punctuation"},")"),s(`

    `),n("span",{class:"token comment"},"# \u635F\u5931\u7F29\u653E"),s(`
    scaler`),n("span",{class:"token punctuation"},"."),s("scale"),n("span",{class:"token punctuation"},"("),s("loss"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},"."),s("backward"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(`

    `),n("span",{class:"token comment"},"# \u68AF\u5EA6\u66F4\u65B0"),s(`
    scaler`),n("span",{class:"token punctuation"},"."),s("step"),n("span",{class:"token punctuation"},"("),s("optimizer"),n("span",{class:"token punctuation"},")"),s(`
    scaler`),n("span",{class:"token punctuation"},"."),s("update"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(`
`)])]),n("h2",{id:"pytorch-\u5B9E\u73B0",tabindex:"-1"},[s("PyTorch \u5B9E\u73B0 "),n("a",{class:"header-anchor",href:"#pytorch-\u5B9E\u73B0","aria-hidden":"true"},"#")]),n("h3",{id:"\u81EA\u52A8\u6DF7\u5408\u7CBE\u5EA6\uFF08amp\uFF09",tabindex:"-1"},[s("\u81EA\u52A8\u6DF7\u5408\u7CBE\u5EA6\uFF08AMP\uFF09 "),n("a",{class:"header-anchor",href:"#\u81EA\u52A8\u6DF7\u5408\u7CBE\u5EA6\uFF08amp\uFF09","aria-hidden":"true"},"#")]),n("p",null,"PyTorch \u63D0\u4F9B\u4E86\u81EA\u52A8\u6DF7\u5408\u7CBE\u5EA6\u529F\u80FD\uFF0C\u7B80\u5316\u4E86\u6DF7\u5408\u7CBE\u5EA6\u8BAD\u7EC3\u7684\u5B9E\u73B0\uFF1A"),n("pre",{class:"language-python"},[n("code",{class:"language-python"},[n("span",{class:"token keyword"},"from"),s(" torch"),n("span",{class:"token punctuation"},"."),s("cuda"),n("span",{class:"token punctuation"},"."),s("amp "),n("span",{class:"token keyword"},"import"),s(" autocast"),n("span",{class:"token punctuation"},","),s(` GradScaler

`),n("span",{class:"token comment"},"# \u521B\u5EFA\u68AF\u5EA6\u7F29\u653E\u5668"),s(`
scaler `),n("span",{class:"token operator"},"="),s(" GradScaler"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(`

`),n("span",{class:"token keyword"},"for"),s(" epoch "),n("span",{class:"token keyword"},"in"),s(),n("span",{class:"token builtin"},"range"),n("span",{class:"token punctuation"},"("),s("num_epochs"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},":"),s(`
    `),n("span",{class:"token keyword"},"for"),s(" batch "),n("span",{class:"token keyword"},"in"),s(" dataloader"),n("span",{class:"token punctuation"},":"),s(`
        optimizer`),n("span",{class:"token punctuation"},"."),s("zero_grad"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(`

        `),n("span",{class:"token comment"},"# \u81EA\u52A8\u6DF7\u5408\u7CBE\u5EA6\u4E0A\u4E0B\u6587"),s(`
        `),n("span",{class:"token keyword"},"with"),s(" autocast"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},":"),s(`
            outputs `),n("span",{class:"token operator"},"="),s(" model"),n("span",{class:"token punctuation"},"("),s("inputs"),n("span",{class:"token punctuation"},")"),s(`
            loss `),n("span",{class:"token operator"},"="),s(" criterion"),n("span",{class:"token punctuation"},"("),s("outputs"),n("span",{class:"token punctuation"},","),s(" targets"),n("span",{class:"token punctuation"},")"),s(`

        `),n("span",{class:"token comment"},"# \u7F29\u653E\u635F\u5931\u5E76\u53CD\u5411\u4F20\u64AD"),s(`
        scaler`),n("span",{class:"token punctuation"},"."),s("scale"),n("span",{class:"token punctuation"},"("),s("loss"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},"."),s("backward"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(`

        `),n("span",{class:"token comment"},"# \u66F4\u65B0\u53C2\u6570"),s(`
        scaler`),n("span",{class:"token punctuation"},"."),s("step"),n("span",{class:"token punctuation"},"("),s("optimizer"),n("span",{class:"token punctuation"},")"),s(`
        scaler`),n("span",{class:"token punctuation"},"."),s("update"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(`
`)])]),n("h2",{id:"\u5173\u952E\u6280\u672F\u70B9",tabindex:"-1"},[s("\u5173\u952E\u6280\u672F\u70B9 "),n("a",{class:"header-anchor",href:"#\u5173\u952E\u6280\u672F\u70B9","aria-hidden":"true"},"#")]),n("h3",{id:"_1-\u5C42\u7CBE\u5EA6\u9009\u62E9\u7B56\u7565",tabindex:"-1"},[s("1. \u5C42\u7CBE\u5EA6\u9009\u62E9\u7B56\u7565 "),n("a",{class:"header-anchor",href:"#_1-\u5C42\u7CBE\u5EA6\u9009\u62E9\u7B56\u7565","aria-hidden":"true"},"#")]),n("pre",{class:"language-mermaid"},[n("code",{class:"language-mermaid"},[n("span",{class:"token keyword"},"graph"),s(` LR
    A`),n("span",{class:"token text string"},"[\u8F93\u5165\u5C42]"),s(),n("span",{class:"token arrow operator"},"-->"),s(" B"),n("span",{class:"token text string"},"[\u5377\u79EF/\u7EBF\u6027\u5C42<br/>FP16]"),s(`
    B `),n("span",{class:"token arrow operator"},"-->"),s(" C"),n("span",{class:"token text string"},"[\u6279\u5F52\u4E00\u5316<br/>FP32]"),s(`
    C `),n("span",{class:"token arrow operator"},"-->"),s(" D"),n("span",{class:"token text string"},"[\u6FC0\u6D3B\u51FD\u6570<br/>FP16]"),s(`
    D `),n("span",{class:"token arrow operator"},"-->"),s(" E"),n("span",{class:"token text string"},"[Dropout<br/>FP16]"),s(`
    E `),n("span",{class:"token arrow operator"},"-->"),s(" F"),n("span",{class:"token text string"},"[\u8F93\u51FA\u5C42<br/>FP32]"),s(`
    F `),n("span",{class:"token arrow operator"},"-->"),s(" G"),n("span",{class:"token text string"},"[\u635F\u5931\u8BA1\u7B97<br/>FP32]"),s(`

    `),n("span",{class:"token keyword"},"style"),s(" B "),n("span",{class:"token style"},[n("span",{class:"token property"},"fill"),n("span",{class:"token operator"},":"),s("#e1f5fe")]),s(`
    `),n("span",{class:"token keyword"},"style"),s(" C "),n("span",{class:"token style"},[n("span",{class:"token property"},"fill"),n("span",{class:"token operator"},":"),s("#fff3e0")]),s(`
    `),n("span",{class:"token keyword"},"style"),s(" D "),n("span",{class:"token style"},[n("span",{class:"token property"},"fill"),n("span",{class:"token operator"},":"),s("#e1f5fe")]),s(`
    `),n("span",{class:"token keyword"},"style"),s(" E "),n("span",{class:"token style"},[n("span",{class:"token property"},"fill"),n("span",{class:"token operator"},":"),s("#e1f5fe")]),s(`
    `),n("span",{class:"token keyword"},"style"),s(" F "),n("span",{class:"token style"},[n("span",{class:"token property"},"fill"),n("span",{class:"token operator"},":"),s("#fff3e0")]),s(`
    `),n("span",{class:"token keyword"},"style"),s(" G "),n("span",{class:"token style"},[n("span",{class:"token property"},"fill"),n("span",{class:"token operator"},":"),s("#fff3e0")]),s(`
`)])]),n("h3",{id:"_2-\u52A8\u6001\u635F\u5931\u7F29\u653E",tabindex:"-1"},[s("2. \u52A8\u6001\u635F\u5931\u7F29\u653E "),n("a",{class:"header-anchor",href:"#_2-\u52A8\u6001\u635F\u5931\u7F29\u653E","aria-hidden":"true"},"#")]),n("p",null,"\u52A8\u6001\u635F\u5931\u7F29\u653E\u53EF\u4EE5\u81EA\u52A8\u8C03\u6574\u7F29\u653E\u56E0\u5B50\uFF0C\u4F18\u5316\u8BAD\u7EC3\u7A33\u5B9A\u6027\uFF1A"),n("pre",{class:"language-python"},[n("code",{class:"language-python"},[n("span",{class:"token keyword"},"class"),s(),n("span",{class:"token class-name"},"DynamicLossScaler"),n("span",{class:"token punctuation"},":"),s(`
    `),n("span",{class:"token keyword"},"def"),s(),n("span",{class:"token function"},"__init__"),n("span",{class:"token punctuation"},"("),s("self"),n("span",{class:"token punctuation"},","),s(" init_scale"),n("span",{class:"token operator"},"="),n("span",{class:"token number"},"2."),n("span",{class:"token operator"},"**"),n("span",{class:"token number"},"16"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},":"),s(`
        self`),n("span",{class:"token punctuation"},"."),s("scale "),n("span",{class:"token operator"},"="),s(` init_scale
        self`),n("span",{class:"token punctuation"},"."),s("growth_factor "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"2.0"),s(`
        self`),n("span",{class:"token punctuation"},"."),s("backoff_factor "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0.5"),s(`
        self`),n("span",{class:"token punctuation"},"."),s("growth_interval "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"2000"),s(`
        self`),n("span",{class:"token punctuation"},"."),s("consecutive_successes "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),s(`

    `),n("span",{class:"token keyword"},"def"),s(),n("span",{class:"token function"},"scale_loss"),n("span",{class:"token punctuation"},"("),s("self"),n("span",{class:"token punctuation"},","),s(" loss"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},":"),s(`
        `),n("span",{class:"token keyword"},"return"),s(" loss "),n("span",{class:"token operator"},"*"),s(" self"),n("span",{class:"token punctuation"},"."),s(`scale

    `),n("span",{class:"token keyword"},"def"),s(),n("span",{class:"token function"},"update"),n("span",{class:"token punctuation"},"("),s("self"),n("span",{class:"token punctuation"},","),s(" overflow"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},":"),s(`
        `),n("span",{class:"token keyword"},"if"),s(" overflow"),n("span",{class:"token punctuation"},":"),s(`
            self`),n("span",{class:"token punctuation"},"."),s("scale "),n("span",{class:"token operator"},"*="),s(" self"),n("span",{class:"token punctuation"},"."),s(`backoff_factor
            self`),n("span",{class:"token punctuation"},"."),s("consecutive_successes "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),s(`
        `),n("span",{class:"token keyword"},"else"),n("span",{class:"token punctuation"},":"),s(`
            self`),n("span",{class:"token punctuation"},"."),s("consecutive_successes "),n("span",{class:"token operator"},"+="),s(),n("span",{class:"token number"},"1"),s(`
            `),n("span",{class:"token keyword"},"if"),s(" self"),n("span",{class:"token punctuation"},"."),s("consecutive_successes "),n("span",{class:"token operator"},">="),s(" self"),n("span",{class:"token punctuation"},"."),s("growth_interval"),n("span",{class:"token punctuation"},":"),s(`
                self`),n("span",{class:"token punctuation"},"."),s("scale "),n("span",{class:"token operator"},"*="),s(" self"),n("span",{class:"token punctuation"},"."),s(`growth_factor
                self`),n("span",{class:"token punctuation"},"."),s("consecutive_successes "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),s(`
`)])]),n("h4",{id:"\u786C\u4EF6\u8981\u6C42\u4E0E\u6027\u80FD",tabindex:"-1"},[s("\u786C\u4EF6\u8981\u6C42\u4E0E\u6027\u80FD "),n("a",{class:"header-anchor",href:"#\u786C\u4EF6\u8981\u6C42\u4E0E\u6027\u80FD","aria-hidden":"true"},"#")]),n("p",null,"\u6DF7\u5408\u7CBE\u5EA6\u8BAD\u7EC3\u9700\u8981\u652F\u6301 Tensor Core \u7684 GPU\uFF1A"),n("ul",null,[n("li",null,[n("strong",null,"Volta \u67B6\u6784\uFF08V100\uFF09"),s("\uFF1A\u9996\u6B21\u652F\u6301 Tensor Core")]),n("li",null,[n("strong",null,"Turing \u67B6\u6784\uFF08RTX 20 \u7CFB\u5217\uFF09"),s("\uFF1A\u6539\u8FDB\u7684 Tensor Core")]),n("li",null,[n("strong",null,"Ampere \u67B6\u6784\uFF08A100, RTX 30 \u7CFB\u5217\uFF09"),s("\uFF1A\u7B2C\u4E09\u4EE3 Tensor Core")]),n("li",null,[n("strong",null,"Ada Lovelace\uFF08RTX 40 \u7CFB\u5217\uFF09"),s("\uFF1A\u7B2C\u56DB\u4EE3 Tensor Core")])]),n("h4",{id:"\u6027\u80FD\u63D0\u5347\u5BF9\u6BD4",tabindex:"-1"},[s("\u6027\u80FD\u63D0\u5347\u5BF9\u6BD4 "),n("a",{class:"header-anchor",href:"#\u6027\u80FD\u63D0\u5347\u5BF9\u6BD4","aria-hidden":"true"},"#")]),n("p",null,[s("\u4E0B\u56FE\u5C55\u793A\u4E86\u6DF7\u5408\u7CBE\u5EA6\u8BAD\u7EC3\u4E0E FP32 \u8BAD\u7EC3\u7684\u5BF9\u6BD4\u6548\u679C\uFF1A "),n("img",{src:i,alt:"\u8BAD\u7EC3\u635F\u5931\u5BF9\u6BD4"})]),n("table",null,[n("thead",null,[n("tr",null,[n("th",null,"\u6A21\u578B\u7C7B\u578B"),n("th",null,"FP32 \u57FA\u7EBF"),n("th",null,"FP16 \u52A0\u901F\u6BD4"),n("th",null,"\u663E\u5B58\u8282\u7701")])]),n("tbody",null,[n("tr",null,[n("td",null,"BERT-Base"),n("td",null,"1.0x"),n("td",null,"1.6x"),n("td",null,"47%")]),n("tr",null,[n("td",null,"GPT-2"),n("td",null,"1.0x"),n("td",null,"1.8x"),n("td",null,"51%")]),n("tr",null,[n("td",null,"ResNet-50"),n("td",null,"1.0x"),n("td",null,"1.4x"),n("td",null,"45%")]),n("tr",null,[n("td",null,"Transformer-XL"),n("td",null,"1.0x"),n("td",null,"1.9x"),n("td",null,"52%")])])]),n("h2",{id:"\u5E38\u89C1\u95EE\u9898\u4E0E\u89E3\u51B3\u65B9\u6848",tabindex:"-1"},[s("\u5E38\u89C1\u95EE\u9898\u4E0E\u89E3\u51B3\u65B9\u6848 "),n("a",{class:"header-anchor",href:"#\u5E38\u89C1\u95EE\u9898\u4E0E\u89E3\u51B3\u65B9\u6848","aria-hidden":"true"},"#")]),n("h3",{id:"_1-\u68AF\u5EA6-underflow",tabindex:"-1"},[s("1. \u68AF\u5EA6 Underflow "),n("a",{class:"header-anchor",href:"#_1-\u68AF\u5EA6-underflow","aria-hidden":"true"},"#")]),n("p",null,[n("strong",null,"\u95EE\u9898"),s("\uFF1A\u5C0F\u68AF\u5EA6\u5728 FP16 \u8868\u793A\u4E0B\u53D8\u4E3A 0")]),n("p",null,[n("strong",null,"\u89E3\u51B3\u65B9\u6848"),s("\uFF1A")]),n("ul",null,[n("li",null,"\u4F7F\u7528\u68AF\u5EA6\u7F29\u653E"),n("li",null,"\u8C03\u6574\u5B66\u4E60\u7387"),n("li",null,"\u4F7F\u7528 BF16 \u66FF\u4EE3 FP16")]),n("h3",{id:"_2-\u6570\u503C\u4E0D\u7A33\u5B9A",tabindex:"-1"},[s("2. \u6570\u503C\u4E0D\u7A33\u5B9A "),n("a",{class:"header-anchor",href:"#_2-\u6570\u503C\u4E0D\u7A33\u5B9A","aria-hidden":"true"},"#")]),n("p",null,[n("strong",null,"\u95EE\u9898"),s("\uFF1A\u67D0\u4E9B\u64CD\u4F5C\u5728 FP16 \u4E0B\u6570\u503C\u4E0D\u7A33\u5B9A")]),n("p",null,[n("strong",null,"\u89E3\u51B3\u65B9\u6848"),s("\uFF1A")]),n("ul",null,[n("li",null,"\u5173\u952E\u5C42\u4FDD\u6301 FP32 \u7CBE\u5EA6"),n("li",null,"\u4F7F\u7528\u6DF7\u5408\u7CBE\u5EA6\u767D\u540D\u5355/\u9ED1\u540D\u5355"),n("li",null,"\u76D1\u63A7\u68AF\u5EA6\u8303\u6570")]),n("h3",{id:"_3-\u6027\u80FD\u4F18\u5316\u5EFA\u8BAE",tabindex:"-1"},[s("3. \u6027\u80FD\u4F18\u5316\u5EFA\u8BAE "),n("a",{class:"header-anchor",href:"#_3-\u6027\u80FD\u4F18\u5316\u5EFA\u8BAE","aria-hidden":"true"},"#")]),n("pre",{class:"language-python"},[n("code",{class:"language-python"},[n("span",{class:"token comment"},"# \u4F18\u5316\u5EFA\u8BAE"),s(`
`),n("span",{class:"token keyword"},"def"),s(),n("span",{class:"token function"},"optimize_mixed_precision"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},":"),s(`
    `),n("span",{class:"token comment"},"# 1. \u5408\u9002\u7684batch size\uFF08\u5229\u7528Tensor Core\u9700\u89818\u7684\u500D\u6570\uFF09"),s(`
    batch_size `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"32"),s(`

    `),n("span",{class:"token comment"},"# 2. \u7EBF\u6027\u5C42\u7EF4\u5EA6\u8BBE\u4E3A8\u7684\u500D\u6570"),s(`
    hidden_size `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"768"),s(`

    `),n("span",{class:"token comment"},"# 3. \u5B9A\u671F\u6E05\u7406GPU\u7F13\u5B58"),s(`
    torch`),n("span",{class:"token punctuation"},"."),s("cuda"),n("span",{class:"token punctuation"},"."),s("empty_cache"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(`
`)])]),n("h2",{id:"\u6700\u4F73\u5B9E\u8DF5",tabindex:"-1"},[s("\u6700\u4F73\u5B9E\u8DF5 "),n("a",{class:"header-anchor",href:"#\u6700\u4F73\u5B9E\u8DF5","aria-hidden":"true"},"#")]),n("h3",{id:"\u8BAD\u7EC3\u914D\u7F6E\u5EFA\u8BAE",tabindex:"-1"},[s("\u8BAD\u7EC3\u914D\u7F6E\u5EFA\u8BAE "),n("a",{class:"header-anchor",href:"#\u8BAD\u7EC3\u914D\u7F6E\u5EFA\u8BAE","aria-hidden":"true"},"#")]),n("pre",{class:"language-python"},[n("code",{class:"language-python"},[n("span",{class:"token comment"},"# \u63A8\u8350\u7684PyTorch\u8BAD\u7EC3\u914D\u7F6E"),s(`
`),n("span",{class:"token keyword"},"from"),s(" torch"),n("span",{class:"token punctuation"},"."),s("cuda"),n("span",{class:"token punctuation"},"."),s("amp "),n("span",{class:"token keyword"},"import"),s(" autocast"),n("span",{class:"token punctuation"},","),s(` GradScaler

`),n("span",{class:"token keyword"},"def"),s(),n("span",{class:"token function"},"train_with_mixed_precision"),n("span",{class:"token punctuation"},"("),s("model"),n("span",{class:"token punctuation"},","),s(" dataloader"),n("span",{class:"token punctuation"},","),s(" optimizer"),n("span",{class:"token punctuation"},","),s(" criterion"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},":"),s(`
    scaler `),n("span",{class:"token operator"},"="),s(" GradScaler"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(`

    `),n("span",{class:"token keyword"},"for"),s(" epoch "),n("span",{class:"token keyword"},"in"),s(),n("span",{class:"token builtin"},"range"),n("span",{class:"token punctuation"},"("),s("num_epochs"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},":"),s(`
        `),n("span",{class:"token keyword"},"for"),s(" batch_idx"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token punctuation"},"("),s("inputs"),n("span",{class:"token punctuation"},","),s(" targets"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token keyword"},"in"),s(),n("span",{class:"token builtin"},"enumerate"),n("span",{class:"token punctuation"},"("),s("dataloader"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},":"),s(`
            optimizer`),n("span",{class:"token punctuation"},"."),s("zero_grad"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(`

            `),n("span",{class:"token comment"},"# \u6DF7\u5408\u7CBE\u5EA6\u524D\u5411\u4F20\u64AD"),s(`
            `),n("span",{class:"token keyword"},"with"),s(" autocast"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},":"),s(`
                outputs `),n("span",{class:"token operator"},"="),s(" model"),n("span",{class:"token punctuation"},"("),s("inputs"),n("span",{class:"token punctuation"},")"),s(`
                loss `),n("span",{class:"token operator"},"="),s(" criterion"),n("span",{class:"token punctuation"},"("),s("outputs"),n("span",{class:"token punctuation"},","),s(" targets"),n("span",{class:"token punctuation"},")"),s(`

            `),n("span",{class:"token comment"},"# \u68AF\u5EA6\u7F29\u653E\u548C\u53CD\u5411\u4F20\u64AD"),s(`
            scaler`),n("span",{class:"token punctuation"},"."),s("scale"),n("span",{class:"token punctuation"},"("),s("loss"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},"."),s("backward"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(`

            `),n("span",{class:"token comment"},"# \u68AF\u5EA6\u88C1\u526A\uFF08\u53EF\u9009\uFF09"),s(`
            scaler`),n("span",{class:"token punctuation"},"."),s("unscale_"),n("span",{class:"token punctuation"},"("),s("optimizer"),n("span",{class:"token punctuation"},")"),s(`
            torch`),n("span",{class:"token punctuation"},"."),s("nn"),n("span",{class:"token punctuation"},"."),s("utils"),n("span",{class:"token punctuation"},"."),s("clip_grad_norm_"),n("span",{class:"token punctuation"},"("),s("model"),n("span",{class:"token punctuation"},"."),s("parameters"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},","),s(" max_norm"),n("span",{class:"token operator"},"="),n("span",{class:"token number"},"1.0"),n("span",{class:"token punctuation"},")"),s(`

            `),n("span",{class:"token comment"},"# \u53C2\u6570\u66F4\u65B0"),s(`
            scaler`),n("span",{class:"token punctuation"},"."),s("step"),n("span",{class:"token punctuation"},"("),s("optimizer"),n("span",{class:"token punctuation"},")"),s(`
            scaler`),n("span",{class:"token punctuation"},"."),s("update"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(`
`)])]),n("h2",{id:"\u53C2\u8003\u8D44\u6599",tabindex:"-1"},[s("\u53C2\u8003\u8D44\u6599 "),n("a",{class:"header-anchor",href:"#\u53C2\u8003\u8D44\u6599","aria-hidden":"true"},"#")]),n("ul",null,[n("li",null,[n("a",{href:"https://docs.nvidia.com/deeplearning/performance/mixed-precision-training/index.html",target:"_blank",rel:"noopener"},"NVIDIA Mixed Precision Training")]),n("li",null,[n("a",{href:"https://pytorch.org/docs/stable/amp.html",target:"_blank",rel:"noopener"},"PyTorch Automatic Mixed Precision")]),n("li",null,[n("a",{href:"https://arxiv.org/abs/1710.03740",target:"_blank",rel:"noopener"},'Micikevicius et al. "Mixed Precision Training" ICLR 2018')])])],-1)])]),_:1})}}};export{y as date,_ as default,b as meta,g as title,w as type};
